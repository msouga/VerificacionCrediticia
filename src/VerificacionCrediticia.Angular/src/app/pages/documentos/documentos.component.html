<div class="documentos-container">
  <h1>Procesamiento de Documentos</h1>

  <!-- Upload -->
  <mat-card class="upload-card">
    <mat-card-header>
      <mat-card-title>Subir DNI</mat-card-title>
      <mat-card-subtitle>Suba una imagen o PDF del DNI para extraer los datos automaticamente</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="drop-zone"
           [class.drag-over]="dragOver"
           [class.has-file]="archivoSeleccionado"
           (dragover)="onDragOver($event)"
           (dragleave)="onDragLeave($event)"
           (drop)="onDrop($event)"
           (click)="fileInput.click()">
        <input #fileInput type="file" hidden
               accept=".pdf,.jpg,.jpeg,.png,.bmp,.tiff"
               (change)="onFileSelected($event)">
        @if (archivoSeleccionado) {
          <mat-icon class="file-icon">description</mat-icon>
          <span class="file-name">{{ archivoSeleccionado.name }}</span>
          <span class="file-size">{{ (archivoSeleccionado.size / 1024) | number:'1.0-0' }} KB</span>
        } @else {
          <mat-icon class="upload-icon">cloud_upload</mat-icon>
          <span class="drop-text">Arrastre el archivo aqui o haga clic para seleccionar</span>
          <span class="drop-hint">PDF, JPG, PNG (max. 4 MB)</span>
        }
      </div>

      <div class="actions-row">
        @if (loading) {
          <button mat-flat-button color="primary" disabled>
            <mat-spinner diameter="20"></mat-spinner>
            <span>Procesando...</span>
          </button>
        } @else {
          <button mat-flat-button color="primary"
                  [disabled]="!archivoSeleccionado"
                  (click)="procesar()">
            <mat-icon>document_scanner</mat-icon>
            <span>Procesar DNI</span>
          </button>
        }
        @if (archivoSeleccionado) {
          <button mat-stroked-button (click)="limpiar()" [disabled]="loading">
            <mat-icon>clear</mat-icon>
            <span>Limpiar</span>
          </button>
        }
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Error -->
  @if (error) {
    <mat-card class="error-card">
      <mat-card-content>
        <mat-icon>error</mat-icon>
        {{ error }}
      </mat-card-content>
    </mat-card>
  }

  <!-- Resultado -->
  @if (resultado) {
    <div class="resultado-section">
      <!-- Header con nombre -->
      <div class="resultado-header">
        <div class="header-left">
          <mat-icon class="header-icon">badge</mat-icon>
          <div>
            <h2>{{ getNombreCompleto() }}</h2>
            <span class="doc-number">DNI: {{ resultado.numeroDocumento || 'No disponible' }}</span>
          </div>
        </div>
        <div class="header-confianza">
          <span class="confianza-valor" [class]="getConfianzaColor(resultado.confianzaPromedio)">
            {{ resultado.confianzaPromedio | percent:'1.0-0' }}
          </span>
          <span class="confianza-label">Confianza</span>
        </div>
      </div>

      <!-- Datos extraidos -->
      <mat-card class="datos-card">
        <mat-card-header>
          <mat-card-title>Datos Extraidos</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="datos-grid">
            <div class="dato-item">
              <span class="dato-label">Nombres</span>
              <span class="dato-valor">{{ resultado.nombres || '-' }}</span>
            </div>
            <div class="dato-item">
              <span class="dato-label">Apellidos</span>
              <span class="dato-valor">{{ resultado.apellidos || '-' }}</span>
            </div>
            <div class="dato-item">
              <span class="dato-label">Nro. Documento</span>
              <span class="dato-valor">{{ resultado.numeroDocumento || '-' }}</span>
            </div>
            <div class="dato-item">
              <span class="dato-label">Fecha de Nacimiento</span>
              <span class="dato-valor">{{ resultado.fechaNacimiento || '-' }}</span>
            </div>
            <div class="dato-item">
              <span class="dato-label">Fecha de Expiracion</span>
              <span class="dato-valor">{{ resultado.fechaExpiracion || '-' }}</span>
            </div>
            <div class="dato-item">
              <span class="dato-label">Sexo</span>
              <span class="dato-valor">{{ resultado.sexo || '-' }}</span>
            </div>
            <div class="dato-item">
              <span class="dato-label">Estado Civil</span>
              <span class="dato-valor">{{ resultado.estadoCivil || '-' }}</span>
            </div>
            <div class="dato-item">
              <span class="dato-label">Nacionalidad</span>
              <span class="dato-valor">{{ resultado.nacionalidad || '-' }}</span>
            </div>
            <div class="dato-item full-width">
              <span class="dato-label">Direccion</span>
              <span class="dato-valor">{{ resultado.direccion || '-' }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Confianza por campo -->
      <mat-card class="confianza-card">
        <mat-card-header>
          <mat-card-title>Confianza por Campo</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="confianza-grid">
            @for (item of resultado.confianza | keyvalue; track item.key) {
              <div class="confianza-item">
                <div class="confianza-header">
                  <span class="confianza-campo">{{ getConfianzaLabel(item.key) }}</span>
                  <span class="confianza-pct" [class]="getConfianzaColor(item.value)">
                    {{ item.value | percent:'1.0-0' }}
                  </span>
                </div>
                <mat-progress-bar mode="determinate"
                                  [value]="item.value * 100"
                                  [class]="'bar-' + getConfianzaColor(item.value)">
                </mat-progress-bar>
              </div>
            }
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  }
</div>
