<div class="configuracion-container">
  <h2>Configuracion de Tipos de Documento</h2>

  @if (cargando) {
    <div class="spinner-container">
      <mat-spinner diameter="40"></mat-spinner>
    </div>
  } @else {
    <mat-card>
      <mat-card-content>
        @if (hayTiposModificados) {
          <div class="seccion-acciones-guardar">
            <button mat-stroked-button (click)="descartarCambiosTipos()" [disabled]="guardandoTipos">
              <mat-icon>undo</mat-icon>
              Descartar cambios
            </button>
            <button mat-flat-button color="primary" (click)="guardarTipos()" [disabled]="guardandoTipos">
              @if (guardandoTipos) {
                <mat-spinner diameter="18" class="btn-spinner"></mat-spinner>
              } @else {
                <mat-icon>save</mat-icon>
              }
              Guardar cambios
            </button>
          </div>
        }
        <table mat-table [dataSource]="tipos" class="tipos-table">

          <ng-container matColumnDef="nombre">
            <th mat-header-cell *matHeaderCellDef>Nombre</th>
            <td mat-cell *matCellDef="let tipo">{{ tipo.nombre }}</td>
          </ng-container>

          <ng-container matColumnDef="codigo">
            <th mat-header-cell *matHeaderCellDef>Codigo</th>
            <td mat-cell *matCellDef="let tipo">
              <code>{{ tipo.codigo }}</code>
            </td>
          </ng-container>

          <ng-container matColumnDef="analyzerId">
            <th mat-header-cell *matHeaderCellDef>Analyzer ID</th>
            <td mat-cell *matCellDef="let tipo">
              <code>{{ tipo.analyzerId || '(ninguno)' }}</code>
            </td>
          </ng-container>

          <ng-container matColumnDef="obligatorio">
            <th mat-header-cell *matHeaderCellDef>Obligatorio</th>
            <td mat-cell *matCellDef="let tipo">
              <mat-slide-toggle
                [checked]="tipo.esObligatorio"
                [disabled]="guardandoTipos"
                (change)="onTipoToggleObligatorio(tipo, $event.checked)">
              </mat-slide-toggle>
            </td>
          </ng-container>

          <ng-container matColumnDef="activo">
            <th mat-header-cell *matHeaderCellDef>Activo</th>
            <td mat-cell *matCellDef="let tipo">
              <mat-slide-toggle
                [checked]="tipo.activo"
                [disabled]="guardandoTipos"
                (change)="onTipoToggleActivo(tipo, $event.checked)">
              </mat-slide-toggle>
            </td>
          </ng-container>

          <ng-container matColumnDef="orden">
            <th mat-header-cell *matHeaderCellDef>Orden</th>
            <td mat-cell *matCellDef="let tipo">
              <input
                type="number"
                class="orden-input"
                [value]="tipo.orden"
                [disabled]="guardandoTipos"
                (input)="onTipoOrdenChange(tipo, $event)"
                min="0"
                max="99">
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"
              [class.inactivo]="!row.activo"
              [class.fila-modificada]="isTipoModificado(row)"></tr>
        </table>
      </mat-card-content>
    </mat-card>
  }

  <h2 class="seccion-reglas">Reglas de Evaluacion</h2>

  @if (cargandoReglas) {
    <div class="spinner-container">
      <mat-spinner diameter="40"></mat-spinner>
    </div>
  } @else {
    <mat-card>
      <mat-card-content>
        <div class="reglas-header">
          @if (hayReglasModificadas) {
            <div class="reglas-acciones-guardar">
              <button mat-stroked-button (click)="descartarCambiosReglas()" [disabled]="guardandoReglas">
                <mat-icon>undo</mat-icon>
                Descartar cambios
              </button>
              <button mat-flat-button color="primary" (click)="guardarReglas()" [disabled]="guardandoReglas">
                @if (guardandoReglas) {
                  <mat-spinner diameter="18" class="btn-spinner"></mat-spinner>
                } @else {
                  <mat-icon>save</mat-icon>
                }
                Guardar cambios
              </button>
            </div>
          }
          <button mat-flat-button color="primary" (click)="abrirNuevaRegla()">
            <mat-icon>add</mat-icon>
            Agregar regla
          </button>
        </div>

        <div class="reglas-table-container">
          <table mat-table [dataSource]="reglas" class="reglas-table">

            <ng-container matColumnDef="nombre">
              <th mat-header-cell *matHeaderCellDef>Nombre</th>
              <td mat-cell *matCellDef="let regla" [class.regla-modificada]="isReglaModificada(regla)">
                <span class="regla-nombre">{{ regla.nombre }}</span>
                <span class="regla-descripcion">{{ generarDescripcion(regla) }}</span>
              </td>
            </ng-container>

            <ng-container matColumnDef="campo">
              <th mat-header-cell *matHeaderCellDef>Campo</th>
              <td mat-cell *matCellDef="let regla">
                <code>{{ regla.campo }}</code>
              </td>
            </ng-container>

            <ng-container matColumnDef="operador">
              <th mat-header-cell *matHeaderCellDef>Op.</th>
              <td mat-cell *matCellDef="let regla">
                <select
                  class="inline-select operador-select"
                  [value]="regla.operador"
                  [disabled]="guardandoReglas"
                  (change)="onOperadorChange(regla, +$any($event.target).value)">
                  @for (op of operadores; track op.valor) {
                    <option [value]="op.valor">{{ op.simbolo }}</option>
                  }
                </select>
              </td>
            </ng-container>

            <ng-container matColumnDef="valor">
              <th mat-header-cell *matHeaderCellDef>Valor</th>
              <td mat-cell *matCellDef="let regla">
                <input
                  type="number"
                  class="valor-input"
                  [value]="regla.valor"
                  [disabled]="guardandoReglas"
                  (input)="onReglaValorChange(regla, $event)"
                  step="any">
              </td>
            </ng-container>

            <ng-container matColumnDef="peso">
              <th mat-header-cell *matHeaderCellDef>Peso</th>
              <td mat-cell *matCellDef="let regla">
                <input
                  type="number"
                  class="peso-input"
                  [value]="regla.peso"
                  [disabled]="guardandoReglas"
                  (input)="onReglaPesoChange(regla, $event)"
                  min="0"
                  max="1"
                  step="0.05">
              </td>
            </ng-container>

            <ng-container matColumnDef="resultado">
              <th mat-header-cell *matHeaderCellDef>Resultado</th>
              <td mat-cell *matCellDef="let regla">
                <select
                  class="inline-select resultado-select"
                  [class]="'inline-select resultado-select resultado-' + getResultadoColor(regla.resultado)"
                  [value]="regla.resultado"
                  [disabled]="guardandoReglas"
                  (change)="onResultadoChange(regla, +$any($event.target).value)">
                  @for (res of resultados; track res.valor) {
                    <option [value]="res.valor">{{ res.nombre }}</option>
                  }
                </select>
              </td>
            </ng-container>

            <ng-container matColumnDef="activa">
              <th mat-header-cell *matHeaderCellDef>Activa</th>
              <td mat-cell *matCellDef="let regla">
                <mat-slide-toggle
                  [checked]="regla.activa"
                  [disabled]="guardandoReglas"
                  (change)="toggleReglaActiva(regla, $event.checked)">
                </mat-slide-toggle>
              </td>
            </ng-container>

            <ng-container matColumnDef="orden">
              <th mat-header-cell *matHeaderCellDef>Orden</th>
              <td mat-cell *matCellDef="let regla">
                <input
                  type="number"
                  class="orden-input"
                  [value]="regla.orden"
                  [disabled]="guardandoReglas"
                  (input)="onReglaOrdenChange(regla, $event)"
                  min="0"
                  max="99">
              </td>
            </ng-container>

            <ng-container matColumnDef="acciones">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let regla">
                <button mat-icon-button color="warn"
                        [disabled]="guardandoReglas"
                        (click)="eliminarRegla(regla)"
                        title="Eliminar regla">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="reglasColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: reglasColumns;"
                [class.inactivo]="!row.activa"></tr>
          </table>
        </div>
      </mat-card-content>
    </mat-card>
  }

  <h2 class="seccion-linea-credito">Parametros de Linea de Credito</h2>

  @if (cargandoLC) {
    <div class="spinner-container">
      <mat-spinner diameter="40"></mat-spinner>
    </div>
  } @else {
    <mat-card>
      <mat-card-content>
        @if (hayParametrosLCModificados) {
          <div class="seccion-acciones-guardar">
            <button mat-stroked-button (click)="descartarCambiosLC()" [disabled]="guardandoLC">
              <mat-icon>undo</mat-icon>
              Descartar cambios
            </button>
            <button mat-flat-button color="primary" (click)="guardarParametrosLC()" [disabled]="guardandoLC">
              @if (guardandoLC) {
                <mat-spinner diameter="18" class="btn-spinner"></mat-spinner>
              } @else {
                <mat-icon>save</mat-icon>
              }
              Guardar cambios
            </button>
          </div>
        }
        <p class="lc-descripcion">
          La linea de credito recomendada se calcula como el minimo entre estos tres limites.
          Ajuste los porcentajes segun la politica crediticia.
        </p>
        <div class="lc-params-grid">
          <div class="lc-param">
            <label>% Capital de Trabajo</label>
            <div class="lc-input-row">
              <input
                type="number"
                class="lc-input"
                [value]="parametrosLC.porcentajeCapitalTrabajo"
                [disabled]="guardandoLC"
                (input)="onParametroLCChange('porcentajeCapitalTrabajo', $event)"
                min="0"
                max="100"
                step="1">
              <span class="lc-suffix">%</span>
            </div>
          </div>
          <div class="lc-param">
            <label>% Patrimonio</label>
            <div class="lc-input-row">
              <input
                type="number"
                class="lc-input"
                [value]="parametrosLC.porcentajePatrimonio"
                [disabled]="guardandoLC"
                (input)="onParametroLCChange('porcentajePatrimonio', $event)"
                min="0"
                max="100"
                step="1">
              <span class="lc-suffix">%</span>
            </div>
          </div>
          <div class="lc-param">
            <label>% Utilidad Neta</label>
            <div class="lc-input-row">
              <input
                type="number"
                class="lc-input"
                [value]="parametrosLC.porcentajeUtilidadNeta"
                [disabled]="guardandoLC"
                (input)="onParametroLCChange('porcentajeUtilidadNeta', $event)"
                min="0"
                max="100"
                step="1">
              <span class="lc-suffix">%</span>
            </div>
          </div>
        </div>
        <h4 class="lc-subseccion">Pesos de Red de Relaciones</h4>
        <p class="lc-descripcion">
          Define cuanto impacta el riesgo detectado en la red de relaciones sobre el score,
          segun el nivel de profundidad del nodo.
        </p>
        <div class="lc-params-grid">
          <div class="lc-param">
            <label>% Nivel 0 (solicitante)</label>
            <div class="lc-input-row">
              <input
                type="number"
                class="lc-input"
                [value]="parametrosLC.pesoRedNivel0"
                [disabled]="guardandoLC"
                (input)="onParametroLCChange('pesoRedNivel0', $event)"
                min="0"
                max="100"
                step="1">
              <span class="lc-suffix">%</span>
            </div>
          </div>
          <div class="lc-param">
            <label>% Nivel 1 (conexiones directas)</label>
            <div class="lc-input-row">
              <input
                type="number"
                class="lc-input"
                [value]="parametrosLC.pesoRedNivel1"
                [disabled]="guardandoLC"
                (input)="onParametroLCChange('pesoRedNivel1', $event)"
                min="0"
                max="100"
                step="1">
              <span class="lc-suffix">%</span>
            </div>
          </div>
          <div class="lc-param">
            <label>% Nivel 2 (conexiones indirectas)</label>
            <div class="lc-input-row">
              <input
                type="number"
                class="lc-input"
                [value]="parametrosLC.pesoRedNivel2"
                [disabled]="guardandoLC"
                (input)="onParametroLCChange('pesoRedNivel2', $event)"
                min="0"
                max="100"
                step="1">
              <span class="lc-suffix">%</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  }
</div>
