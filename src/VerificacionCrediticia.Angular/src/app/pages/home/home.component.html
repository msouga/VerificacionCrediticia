<div class="home-container">
  <!-- Header -->
  <div class="page-header">
    <div>
      <h1>Dashboard</h1>
      <p class="subtitle">{{ today | date:'EEEE d \'de\' MMMM, yyyy' }}</p>
    </div>
    <button mat-flat-button color="primary" (click)="nuevoExpediente()">
      <mat-icon>add</mat-icon>
      Nuevo Expediente
    </button>
  </div>

  @if (cargando) {
    <div class="spinner-container">
      <mat-spinner diameter="40"></mat-spinner>
    </div>
  } @else {
    <!-- Stats Cards -->
    <div class="stats-grid">
      <mat-card class="stat-card primary">
        <mat-card-content>
          <div class="stat-header">
            <mat-icon>folder_open</mat-icon>
          </div>
          <div class="stat-value">{{ stats.totalExpedientes }}</div>
          <div class="stat-label">Total Expedientes</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card success">
        <mat-card-content>
          <div class="stat-header">
            <mat-icon>check_circle</mat-icon>
            @if (stats.evaluados > 0) {
              <span class="stat-trend">{{ porcentajeAprobacion }}%</span>
            }
          </div>
          <div class="stat-value">{{ stats.aprobados }}</div>
          <div class="stat-label">Aprobados</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card warning">
        <mat-card-content>
          <div class="stat-header">
            <mat-icon>pending</mat-icon>
            @if (stats.evaluados > 0) {
              <span class="stat-trend">{{ porcentajeRevision }}%</span>
            }
          </div>
          <div class="stat-value">{{ stats.enRevision }}</div>
          <div class="stat-label">En Revision</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card error">
        <mat-card-content>
          <div class="stat-header">
            <mat-icon>cancel</mat-icon>
            @if (stats.evaluados > 0) {
              <span class="stat-trend">{{ porcentajeRechazo }}%</span>
            }
          </div>
          <div class="stat-value">{{ stats.rechazados }}</div>
          <div class="stat-label">Rechazados</div>
        </mat-card-content>
      </mat-card>
    </div>

    <div class="content-single">
      <mat-card>
        <mat-card-header>
          <mat-card-title>Distribucion por Resultado</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          @if (stats.evaluados > 0) {
            <div class="distribution-item">
              <div class="dist-header">
                <span>Aprobados</span>
                <span class="dist-pct success-text">{{ porcentajeAprobacion }}%</span>
              </div>
              <mat-progress-bar mode="determinate" [value]="porcentajeAprobacion" class="bar-success"></mat-progress-bar>
            </div>
            <div class="distribution-item">
              <div class="dist-header">
                <span>En Revision</span>
                <span class="dist-pct warning-text">{{ porcentajeRevision }}%</span>
              </div>
              <mat-progress-bar mode="determinate" [value]="porcentajeRevision" class="bar-warning"></mat-progress-bar>
            </div>
            <div class="distribution-item">
              <div class="dist-header">
                <span>Rechazados</span>
                <span class="dist-pct error-text">{{ porcentajeRechazo }}%</span>
              </div>
              <mat-progress-bar mode="determinate" [value]="porcentajeRechazo" class="bar-error"></mat-progress-bar>
            </div>
          } @else {
            <p class="empty-state">No hay evaluaciones aun.</p>
          }

          <div class="metrics-grid">
            <div class="metric">
              <div class="metric-value">{{ stats.evaluados }}</div>
              <div class="metric-label">Evaluados</div>
            </div>
            <div class="metric">
              <div class="metric-value">{{ stats.enProceso }}</div>
              <div class="metric-label">En proceso</div>
            </div>
            <div class="metric">
              <div class="metric-value">{{ stats.scorePromedio | number:'1.1-1' }}</div>
              <div class="metric-label">Score promedio</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

    </div>

    <!-- Evaluaciones Recientes -->
    @if (stats.recientes.length > 0) {
      <mat-card class="section-card">
        <mat-card-header>
          <mat-card-title>Evaluaciones Recientes</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <table mat-table [dataSource]="stats.recientes" class="full-width clickable-table">
            <ng-container matColumnDef="descripcion">
              <th mat-header-cell *matHeaderCellDef>Expediente</th>
              <td mat-cell *matCellDef="let e">
                <div>{{ e.descripcion }}</div>
                <div class="caption">
                  @if (e.nombresSolicitante) {
                    {{ e.nombresSolicitante }} {{ e.apellidosSolicitante }}
                  }
                  @if (e.dniSolicitante) {
                    - DNI: {{ e.dniSolicitante }}
                  }
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="empresa">
              <th mat-header-cell *matHeaderCellDef>Empresa</th>
              <td mat-cell *matCellDef="let e">
                @if (e.razonSocialEmpresa) {
                  <div>{{ e.razonSocialEmpresa }}</div>
                  <div class="caption">RUC: {{ e.rucEmpresa }}</div>
                } @else {
                  <span class="caption">-</span>
                }
              </td>
            </ng-container>

            <ng-container matColumnDef="score">
              <th mat-header-cell *matHeaderCellDef>Score</th>
              <td mat-cell *matCellDef="let e">
                <span class="score-chip" [class]="getScoreColor(e.scoreFinal)">
                  {{ e.scoreFinal | number:'1.1-1' }}
                </span>
              </td>
            </ng-container>

            <ng-container matColumnDef="resultado">
              <th mat-header-cell *matHeaderCellDef>Resultado</th>
              <td mat-cell *matCellDef="let e">
                <span class="result-chip" [class]="getResultadoColor(e.recomendacion)">
                  {{ getResultadoTexto(e.recomendacion) }}
                </span>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"
                (click)="verExpediente(row)"
                class="clickable-row"></tr>
          </table>
        </mat-card-content>
      </mat-card>
    }
  }
</div>
