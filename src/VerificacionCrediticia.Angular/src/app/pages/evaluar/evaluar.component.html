<div class="evaluar-container">
  <h1>Evaluar Verificacion Crediticia</h1>

  <!-- Subir DNI -->
  <mat-card class="upload-card">
    <mat-card-header>
      <mat-card-title>1. Documento de Identidad</mat-card-title>
      <mat-card-subtitle>Suba el DNI del solicitante para extraer sus datos automaticamente</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="drop-zone"
           [class.drag-over]="dragOver"
           [class.has-file]="archivoSeleccionado"
           (dragover)="onDragOver($event)"
           (dragleave)="onDragLeave($event)"
           (drop)="onDrop($event)"
           (click)="fileInput.click()">
        <input #fileInput type="file" class="hidden-input"
               accept=".pdf,.jpg,.jpeg,.png,.bmp,.tiff"
               (change)="onFileSelected($event)">
        @if (archivoSeleccionado) {
          <mat-icon class="file-icon">description</mat-icon>
          <span class="file-name">{{ archivoSeleccionado.name }}</span>
          <span class="file-size">{{ (archivoSeleccionado.size / 1024) | number:'1.0-0' }} KB</span>
        } @else {
          <mat-icon class="upload-icon">cloud_upload</mat-icon>
          <span class="drop-text">Arrastre el archivo aqui o haga clic para seleccionar</span>
          <span class="drop-hint">PDF, JPG, PNG (max. 4 MB)</span>
        }
      </div>

      <div class="actions-row">
        @if (loadingDni) {
          <button mat-flat-button color="primary" disabled>
            <mat-spinner diameter="20"></mat-spinner>
            <span>Procesando...</span>
          </button>
        } @else {
          <button mat-flat-button color="primary"
                  [disabled]="!archivoSeleccionado"
                  (click)="procesarDni()">
            <mat-icon>document_scanner</mat-icon>
            <span>Procesar DNI</span>
          </button>
        }
        @if (archivoSeleccionado) {
          <button mat-stroked-button (click)="limpiarDni()" [disabled]="loadingDni">
            <mat-icon>clear</mat-icon>
            <span>Limpiar</span>
          </button>
        }
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Error DNI -->
  @if (dniError) {
    <mat-card class="error-card">
      <mat-card-content>
        <mat-icon>error</mat-icon>
        {{ dniError }}
      </mat-card-content>
    </mat-card>
  }

  <!-- Resultado DNI -->
  @if (dniResultado) {
    <div class="dni-resultado">
      <div class="dni-header">
        <mat-icon class="dni-header-icon">badge</mat-icon>
        <div>
          <h2>{{ getNombreCompleto() }}</h2>
          <span class="dni-doc-number">DNI: {{ dniResultado.numeroDocumento || 'No disponible' }}</span>
        </div>
        <div class="dni-confianza">
          <span class="confianza-valor" [class]="getConfianzaColor(dniResultado.confianzaPromedio)">
            {{ dniResultado.confianzaPromedio | percent:'1.0-0' }}
          </span>
          <span class="confianza-label">Confianza</span>
        </div>
      </div>

      <!-- Validacion RENIEC -->
      @if (dniResultado.dniValidado === true) {
        <div class="reniec-validacion reniec-ok">
          <mat-icon>check_circle</mat-icon>
          <span>{{ dniResultado.mensajeValidacion || 'DNI Validado por RENIEC' }}</span>
        </div>
      } @else if (dniResultado.dniValidado === false) {
        <div class="reniec-validacion reniec-error">
          <mat-icon>cancel</mat-icon>
          <span>{{ dniResultado.mensajeValidacion || 'DNI no validado por RENIEC' }}</span>
        </div>
      }

      <div class="dni-datos-grid">
        <div class="dni-dato">
          <span class="dni-dato-label">Nombres</span>
          <span class="dni-dato-valor">{{ dniResultado.nombres || '-' }}</span>
        </div>
        <div class="dni-dato">
          <span class="dni-dato-label">Apellidos</span>
          <span class="dni-dato-valor">{{ dniResultado.apellidos || '-' }}</span>
        </div>
        <div class="dni-dato">
          <span class="dni-dato-label">Fecha Nac.</span>
          <span class="dni-dato-valor">{{ dniResultado.fechaNacimiento || '-' }}</span>
        </div>
        <div class="dni-dato">
          <span class="dni-dato-label">Sexo</span>
          <span class="dni-dato-valor">{{ dniResultado.sexo || '-' }}</span>
        </div>
        <div class="dni-dato">
          <span class="dni-dato-label">Estado Civil</span>
          <span class="dni-dato-valor">{{ dniResultado.estadoCivil || '-' }}</span>
        </div>
        <div class="dni-dato">
          <span class="dni-dato-label">Fecha Exp.</span>
          <span class="dni-dato-valor">{{ dniResultado.fechaExpiracion || '-' }}</span>
        </div>
        <div class="dni-dato full-width">
          <span class="dni-dato-label">Direccion</span>
          <span class="dni-dato-valor">{{ dniResultado.direccion || '-' }}</span>
        </div>
      </div>

      <!-- Confianza por campo -->
      <mat-expansion-panel class="confianza-panel">
        <mat-expansion-panel-header>
          <mat-panel-title>Confianza por campo</mat-panel-title>
        </mat-expansion-panel-header>
        <div class="confianza-grid">
          @for (item of dniResultado.confianza | keyvalue; track item.key) {
            <div class="confianza-item">
              <div class="confianza-item-header">
                <span>{{ getConfianzaLabel(item.key) }}</span>
                <span class="confianza-pct" [class]="getConfianzaColor(item.value)">
                  {{ item.value | percent:'1.0-0' }}
                </span>
              </div>
              <mat-progress-bar mode="determinate"
                                [value]="item.value * 100"
                                [class]="'bar-' + getConfianzaColor(item.value)">
              </mat-progress-bar>
            </div>
          }
        </div>
      </mat-expansion-panel>
    </div>
  }

  <!-- Subir Vigencia de Poder -->
  <mat-card class="upload-card">
    <mat-card-header>
      <mat-card-title>1.5 Vigencia de Poderes</mat-card-title>
      <mat-card-subtitle>Suba la Vigencia de Poder para extraer datos de la empresa y representantes</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="drop-zone"
           [class.drag-over]="dragOverVigencia"
           [class.has-file]="archivoVigencia"
           (dragover)="onDragOverVigencia($event)"
           (dragleave)="onDragLeaveVigencia($event)"
           (drop)="onDropVigencia($event)"
           (click)="fileInputVigencia.click()">
        <input #fileInputVigencia type="file" class="hidden-input"
               accept=".pdf,.jpg,.jpeg,.png,.bmp,.tiff"
               (change)="onFileSelectedVigencia($event)">
        @if (archivoVigencia) {
          <mat-icon class="file-icon">description</mat-icon>
          <span class="file-name">{{ archivoVigencia.name }}</span>
          <span class="file-size">{{ (archivoVigencia.size / 1024) | number:'1.0-0' }} KB</span>
        } @else {
          <mat-icon class="upload-icon">cloud_upload</mat-icon>
          <span class="drop-text">Arrastre el archivo aqui o haga clic para seleccionar</span>
          <span class="drop-hint">PDF, JPG, PNG (max. 4 MB)</span>
        }
      </div>

      <div class="actions-row">
        @if (loadingVigencia) {
          <button mat-flat-button color="primary" disabled>
            <mat-spinner diameter="20"></mat-spinner>
            <span>Procesando...</span>
          </button>
        } @else {
          <button mat-flat-button color="primary"
                  [disabled]="!archivoVigencia"
                  (click)="procesarVigenciaPoder()">
            <mat-icon>gavel</mat-icon>
            <span>Procesar Vigencia</span>
          </button>
        }
        @if (archivoVigencia) {
          <button mat-stroked-button (click)="limpiarVigencia()" [disabled]="loadingVigencia">
            <mat-icon>clear</mat-icon>
            <span>Limpiar</span>
          </button>
        }
      </div>

      <!-- Progreso SSE -->
      @if (vigenciaProgreso.length > 0) {
        <div class="progreso-lista">
          @for (msg of vigenciaProgreso; track $index) {
            <div class="progreso-item" [class.ultimo]="$last && loadingVigencia">
              @if ($last && loadingVigencia) {
                <mat-spinner diameter="14"></mat-spinner>
              } @else {
                <mat-icon class="progreso-check">check_circle</mat-icon>
              }
              <span>{{ msg }}</span>
            </div>
          }
        </div>
      }
    </mat-card-content>
  </mat-card>

  <!-- Error Vigencia -->
  @if (vigenciaError) {
    <mat-card class="error-card">
      <mat-card-content>
        <mat-icon>error</mat-icon>
        {{ vigenciaError }}
      </mat-card-content>
    </mat-card>
  }

  <!-- Resultado Vigencia de Poder -->
  @if (vigenciaPoder) {
    <div class="vigencia-resultado">
      <div class="vigencia-header">
        <mat-icon class="vigencia-header-icon">business</mat-icon>
        <div>
          <h2>{{ vigenciaPoder.razonSocial || 'Empresa' }}</h2>
          <span class="vigencia-ruc">RUC: {{ vigenciaPoder.ruc || 'No disponible' }}</span>
        </div>
        <div class="dni-confianza">
          <span class="confianza-valor" [class]="getConfianzaColor(vigenciaPoder.confianzaPromedio)">
            {{ vigenciaPoder.confianzaPromedio | percent:'1.0-0' }}
          </span>
          <span class="confianza-label">Confianza</span>
        </div>
      </div>

      <!-- Validacion RUC Equifax -->
      @if (vigenciaPoder.rucValidado === true) {
        <div class="reniec-validacion reniec-ok">
          <mat-icon>check_circle</mat-icon>
          <span>{{ vigenciaPoder.mensajeValidacionRuc || 'RUC verificado en Equifax' }}</span>
        </div>
      } @else if (vigenciaPoder.rucValidado === false) {
        <div class="reniec-validacion reniec-error">
          <mat-icon>cancel</mat-icon>
          <span>{{ vigenciaPoder.mensajeValidacionRuc || 'RUC no encontrado en Equifax' }}</span>
        </div>
      }

      <!-- Datos de la empresa -->
      <div class="dni-datos-grid">
        <div class="dni-dato">
          <span class="dni-dato-label">Tipo Persona Juridica</span>
          <span class="dni-dato-valor">{{ vigenciaPoder.tipoPersonaJuridica || '-' }}</span>
        </div>
        <div class="dni-dato">
          <span class="dni-dato-label">Partida Registral</span>
          <span class="dni-dato-valor">{{ vigenciaPoder.partidaRegistral || '-' }}</span>
        </div>
        <div class="dni-dato">
          <span class="dni-dato-label">Fecha Constitucion</span>
          <span class="dni-dato-valor">{{ vigenciaPoder.fechaConstitucion || '-' }}</span>
        </div>
        <div class="dni-dato">
          <span class="dni-dato-label">Capital Social</span>
          <span class="dni-dato-valor">{{ vigenciaPoder.capitalSocial || '-' }}</span>
        </div>
        <div class="dni-dato full-width">
          <span class="dni-dato-label">Domicilio</span>
          <span class="dni-dato-valor">{{ vigenciaPoder.domicilio || '-' }}</span>
        </div>
        <div class="dni-dato full-width">
          <span class="dni-dato-label">Objeto Social</span>
          <span class="dni-dato-valor">{{ vigenciaPoder.objetoSocial || '-' }}</span>
        </div>
      </div>

      <!-- Tabla de representantes -->
      @if (vigenciaPoder.representantes && vigenciaPoder.representantes.length > 0) {
        <h3 class="representantes-title">Representantes Legales</h3>
        <div class="representantes-table">
          <div class="rep-header">
            <span class="rep-col-nombre">Nombre</span>
            <span class="rep-col-dni">DNI</span>
            <span class="rep-col-cargo">Cargo</span>
            <span class="rep-col-validacion">RENIEC</span>
          </div>
          @for (rep of vigenciaPoder.representantes; track rep.documentoIdentidad) {
            <div class="rep-row">
              <span class="rep-col-nombre">{{ rep.nombre || '-' }}</span>
              <span class="rep-col-dni">{{ rep.documentoIdentidad || '-' }}</span>
              <span class="rep-col-cargo">{{ rep.cargo || '-' }}</span>
              <span class="rep-col-validacion">
                @if (rep.dniValidado === true) {
                  <mat-icon class="validacion-ok">check_circle</mat-icon>
                } @else if (rep.dniValidado === false) {
                  <mat-icon class="validacion-error">cancel</mat-icon>
                } @else {
                  <mat-icon class="validacion-pending">help_outline</mat-icon>
                }
              </span>
            </div>
          }
        </div>
      }

      <!-- Confianza por campo -->
      <mat-expansion-panel class="confianza-panel">
        <mat-expansion-panel-header>
          <mat-panel-title>Confianza por campo</mat-panel-title>
        </mat-expansion-panel-header>
        <div class="confianza-grid">
          @for (item of vigenciaPoder.confianza | keyvalue; track item.key) {
            <div class="confianza-item">
              <div class="confianza-item-header">
                <span>{{ item.key }}</span>
                <span class="confianza-pct" [class]="getConfianzaColor(item.value)">
                  {{ item.value | percent:'1.0-0' }}
                </span>
              </div>
              <mat-progress-bar mode="determinate"
                                [value]="item.value * 100"
                                [class]="'bar-' + getConfianzaColor(item.value)">
              </mat-progress-bar>
            </div>
          }
        </div>
      </mat-expansion-panel>
    </div>
  }

  <!-- Subir Balance General -->
  <mat-card class="upload-card">
    <mat-card-header>
      <mat-card-title>2. Balance General</mat-card-title>
      <mat-card-subtitle>Suba el Balance General para extraer partidas contables y calcular ratios financieros</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="drop-zone"
           [class.drag-over]="dragOverBalance"
           [class.has-file]="archivoBalance"
           (dragover)="onDragOverBalance($event)"
           (dragleave)="onDragLeaveBalance($event)"
           (drop)="onDropBalance($event)"
           (click)="fileInputBalance.click()">
        <input #fileInputBalance type="file" class="hidden-input"
               accept=".pdf,.jpg,.jpeg,.png,.bmp,.tiff"
               (change)="onFileSelectedBalance($event)">
        @if (archivoBalance) {
          <mat-icon class="file-icon">description</mat-icon>
          <span class="file-name">{{ archivoBalance.name }}</span>
          <span class="file-size">{{ (archivoBalance.size / 1024) | number:'1.0-0' }} KB</span>
        } @else {
          <mat-icon class="upload-icon">cloud_upload</mat-icon>
          <span class="drop-text">Arrastre el archivo aqui o haga clic para seleccionar</span>
          <span class="drop-hint">PDF, JPG, PNG (max. 4 MB)</span>
        }
      </div>

      <div class="actions-row">
        @if (loadingBalance) {
          <button mat-flat-button color="primary" disabled>
            <mat-spinner diameter="20"></mat-spinner>
            <span>Procesando...</span>
          </button>
        } @else {
          <button mat-flat-button color="primary"
                  [disabled]="!archivoBalance"
                  (click)="procesarBalance()">
            <mat-icon>account_balance</mat-icon>
            <span>Procesar Balance</span>
          </button>
        }
        @if (archivoBalance) {
          <button mat-stroked-button (click)="limpiarBalance()" [disabled]="loadingBalance">
            <mat-icon>clear</mat-icon>
            <span>Limpiar</span>
          </button>
        }
      </div>

      <!-- Progreso SSE -->
      @if (balanceProgreso.length > 0) {
        <div class="progreso-lista">
          @for (msg of balanceProgreso; track $index) {
            <div class="progreso-item" [class.ultimo]="$last && loadingBalance">
              @if ($last && loadingBalance) {
                <mat-spinner diameter="14"></mat-spinner>
              } @else {
                <mat-icon class="progreso-check">check_circle</mat-icon>
              }
              <span>{{ msg }}</span>
            </div>
          }
        </div>
      }
    </mat-card-content>
  </mat-card>

  <!-- Error Balance -->
  @if (balanceError) {
    <mat-card class="error-card">
      <mat-card-content>
        <mat-icon>error</mat-icon>
        {{ balanceError }}
      </mat-card-content>
    </mat-card>
  }

  <!-- Resultado Balance General -->
  @if (balanceGeneral) {
    <div class="balance-resultado">
      <div class="balance-header">
        <mat-icon class="balance-header-icon">account_balance_wallet</mat-icon>
        <div>
          <h2>{{ balanceGeneral.razonSocial || 'Balance General' }}</h2>
          <span class="balance-info">
            RUC: {{ balanceGeneral.ruc || 'No disponible' }} |
            Fecha: {{ balanceGeneral.fechaBalance || 'No disponible' }} |
            Moneda: {{ balanceGeneral.moneda || 'N/D' }}
          </span>
        </div>
        <div class="balance-confianza">
          <span class="confianza-valor" [class]="getConfianzaColor(balanceGeneral.confianzaPromedio)">
            {{ balanceGeneral.confianzaPromedio | percent:'1.0-0' }}
          </span>
          <span class="confianza-label">Confianza</span>
        </div>
      </div>

      <!-- Validacion RUC Equifax -->
      @if (balanceGeneral.rucValidado === true) {
        <div class="reniec-validacion reniec-ok">
          <mat-icon>verified</mat-icon>
          <span>RUC verificado en Equifax</span>
        </div>
      } @else if (balanceGeneral.rucValidado === false) {
        <div class="reniec-validacion reniec-error">
          <mat-icon>warning</mat-icon>
          <span>{{ balanceGeneral.mensajeValidacionRuc || 'RUC no encontrado en Equifax' }}</span>
        </div>
      } @else if (balanceGeneral.mensajeValidacionRuc) {
        <div class="reniec-validacion reniec-warning">
          <mat-icon>info</mat-icon>
          <span>{{ balanceGeneral.mensajeValidacionRuc }}</span>
        </div>
      }

      <!-- Resumen con totales -->
      <div class="balance-resumen">
        <div class="balance-card" [class]="'card-success'">
          <div class="balance-card-header">
            <mat-icon>trending_up</mat-icon>
            <span>Total Activo</span>
          </div>
          <div class="balance-card-value">
            {{ (balanceGeneral.totalActivo || 0) | currency:'PEN':'symbol':'1.0-0' }}
          </div>
        </div>

        <div class="balance-card" [class]="'card-info'">
          <div class="balance-card-header">
            <mat-icon>trending_down</mat-icon>
            <span>Total Pasivo</span>
          </div>
          <div class="balance-card-value">
            {{ (balanceGeneral.totalPasivo || 0) | currency:'PEN':'symbol':'1.0-0' }}
          </div>
        </div>

        <div class="balance-card" [class]="'card-warning'">
          <div class="balance-card-header">
            <mat-icon>account_balance</mat-icon>
            <span>Patrimonio</span>
          </div>
          <div class="balance-card-value">
            {{ (balanceGeneral.totalPatrimonio || 0) | currency:'PEN':'symbol':'1.0-0' }}
          </div>
        </div>

        <div class="balance-card" [class]="getRatioColor(balanceGeneral.resultadoEjercicio, 'liquidez')">
          <div class="balance-card-header">
            <mat-icon>assessment</mat-icon>
            <span>Resultado del Ejercicio</span>
          </div>
          <div class="balance-card-value">
            {{ (balanceGeneral.resultadoEjercicio || 0) | currency:'PEN':'symbol':'1.0-0' }}
          </div>
        </div>
      </div>

      <!-- Indicadores Financieros -->
      <div class="ratios-section">
        <h3>Indicadores Financieros</h3>
        <div class="ratios-grid">
          <div class="ratio-card" [class]="'card-' + getRatioColor(balanceGeneral.ratioLiquidez, 'liquidez')">
            <div class="ratio-header">
              <mat-icon>water_drop</mat-icon>
              <span>Liquidez</span>
            </div>
            <div class="ratio-value">
              {{ balanceGeneral.ratioLiquidez || 'N/D' }}
            </div>
            <div class="ratio-label">
              {{ getRatioLabel(balanceGeneral.ratioLiquidez, 'liquidez') }}
            </div>
            <div class="ratio-formula">
              Activo Corriente / Pasivo Corriente
            </div>
          </div>

          <div class="ratio-card" [class]="'card-' + getRatioColor(balanceGeneral.ratioEndeudamiento, 'endeudamiento')">
            <div class="ratio-header">
              <mat-icon>trending_down</mat-icon>
              <span>Endeudamiento</span>
            </div>
            <div class="ratio-value">
              {{ (balanceGeneral.ratioEndeudamiento || 0) | percent:'1.2-2' }}
            </div>
            <div class="ratio-label">
              {{ getRatioLabel(balanceGeneral.ratioEndeudamiento, 'endeudamiento') }}
            </div>
            <div class="ratio-formula">
              Total Pasivo / Total Activo
            </div>
          </div>

          <div class="ratio-card" [class]="'card-' + getRatioColor(balanceGeneral.ratioSolvencia, 'solvencia')">
            <div class="ratio-header">
              <mat-icon>shield</mat-icon>
              <span>Solvencia</span>
            </div>
            <div class="ratio-value">
              {{ (balanceGeneral.ratioSolvencia || 0) | percent:'1.2-2' }}
            </div>
            <div class="ratio-label">
              {{ getRatioLabel(balanceGeneral.ratioSolvencia, 'solvencia') }}
            </div>
            <div class="ratio-formula">
              Total Patrimonio / Total Activo
            </div>
          </div>

          <div class="ratio-card" [class]="balanceGeneral.capitalTrabajo! >= 0 ? 'card-success' : 'card-error'">
            <div class="ratio-header">
              <mat-icon>work</mat-icon>
              <span>Capital de Trabajo</span>
            </div>
            <div class="ratio-value">
              {{ (balanceGeneral.capitalTrabajo || 0) | currency:'PEN':'symbol':'1.0-0' }}
            </div>
            <div class="ratio-label">
              {{ balanceGeneral.capitalTrabajo! >= 0 ? 'POSITIVO' : 'NEGATIVO' }}
            </div>
            <div class="ratio-formula">
              Activo Corriente - Pasivo Corriente
            </div>
          </div>
        </div>
      </div>

      <!-- Detalle por secciones -->
      <mat-accordion class="balance-accordion">
        <!-- Activo Corriente -->
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>trending_up</mat-icon>
              Activo Corriente
            </mat-panel-title>
            <mat-panel-description>
              {{ (balanceGeneral.totalActivoCorriente || 0) | currency:'PEN':'symbol':'1.0-0' }}
            </mat-panel-description>
          </mat-expansion-panel-header>
          <div class="partidas-table">
            <div class="partida-row">
              <span class="partida-nombre">Efectivo y Equivalentes</span>
              <span class="partida-monto">{{ (balanceGeneral.efectivoEquivalentes || 0) | currency:'PEN':'symbol':'1.0-0' }}</span>
            </div>
            <div class="partida-row">
              <span class="partida-nombre">Cuentas por Cobrar Comerciales</span>
              <span class="partida-monto">{{ (balanceGeneral.cuentasCobrarComerciales || 0) | currency:'PEN':'symbol':'1.0-0' }}</span>
            </div>
            <div class="partida-row">
              <span class="partida-nombre">Cuentas por Cobrar Diversas</span>
              <span class="partida-monto">{{ (balanceGeneral.cuentasCobrarDiversas || 0) | currency:'PEN':'symbol':'1.0-0' }}</span>
            </div>
            <div class="partida-row">
              <span class="partida-nombre">Existencias</span>
              <span class="partida-monto">{{ (balanceGeneral.existencias || 0) | currency:'PEN':'symbol':'1.0-0' }}</span>
            </div>
            <div class="partida-row">
              <span class="partida-nombre">Gastos Pagados por Anticipado</span>
              <span class="partida-monto">{{ (balanceGeneral.gastosPagadosAnticipado || 0) | currency:'PEN':'symbol':'1.0-0' }}</span>
            </div>
            <div class="partida-row total-row">
              <span class="partida-nombre"><strong>TOTAL ACTIVO CORRIENTE</strong></span>
              <span class="partida-monto"><strong>{{ (balanceGeneral.totalActivoCorriente || 0) | currency:'PEN':'symbol':'1.0-0' }}</strong></span>
            </div>
          </div>
        </mat-expansion-panel>

        <!-- Activo No Corriente -->
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>home</mat-icon>
              Activo No Corriente
            </mat-panel-title>
            <mat-panel-description>
              {{ (balanceGeneral.totalActivoNoCorriente || 0) | currency:'PEN':'symbol':'1.0-0' }}
            </mat-panel-description>
          </mat-expansion-panel-header>
          <div class="partidas-table">
            <div class="partida-row">
              <span class="partida-nombre">Inmuebles, Maquinaria y Equipo</span>
              <span class="partida-monto">{{ (balanceGeneral.inmueblesMaquinariaEquipo || 0) | currency:'PEN':'symbol':'1.0-0' }}</span>
            </div>
            <div class="partida-row">
              <span class="partida-nombre">Depreciación Acumulada</span>
              <span class="partida-monto">{{ (balanceGeneral.depreciacionAcumulada || 0) | currency:'PEN':'symbol':'1.0-0' }}</span>
            </div>
            <div class="partida-row">
              <span class="partida-nombre">Intangibles</span>
              <span class="partida-monto">{{ (balanceGeneral.intangibles || 0) | currency:'PEN':'symbol':'1.0-0' }}</span>
            </div>
            <div class="partida-row">
              <span class="partida-nombre">Amortización Acumulada</span>
              <span class="partida-monto">{{ (balanceGeneral.amortizacionAcumulada || 0) | currency:'PEN':'symbol':'1.0-0' }}</span>
            </div>
            <div class="partida-row">
              <span class="partida-nombre">Activo Diferido</span>
              <span class="partida-monto">{{ (balanceGeneral.activoDiferido || 0) | currency:'PEN':'symbol':'1.0-0' }}</span>
            </div>
            <div class="partida-row total-row">
              <span class="partida-nombre"><strong>TOTAL ACTIVO NO CORRIENTE</strong></span>
              <span class="partida-monto"><strong>{{ (balanceGeneral.totalActivoNoCorriente || 0) | currency:'PEN':'symbol':'1.0-0' }}</strong></span>
            </div>
          </div>
        </mat-expansion-panel>

        <!-- Pasivo Corriente -->
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>trending_down</mat-icon>
              Pasivo Corriente
            </mat-panel-title>
            <mat-panel-description>
              {{ (balanceGeneral.totalPasivoCorriente || 0) | currency:'PEN':'symbol':'1.0-0' }}
            </mat-panel-description>
          </mat-expansion-panel-header>
          <div class="partidas-table">
            <div class="partida-row">
              <span class="partida-nombre">Tributos por Pagar</span>
              <span class="partida-monto">{{ (balanceGeneral.tributosPorPagar || 0) | currency:'PEN':'symbol':'1.0-0' }}</span>
            </div>
            <div class="partida-row">
              <span class="partida-nombre">Remuneraciones por Pagar</span>
              <span class="partida-monto">{{ (balanceGeneral.remuneracionesPorPagar || 0) | currency:'PEN':'symbol':'1.0-0' }}</span>
            </div>
            <div class="partida-row">
              <span class="partida-nombre">Cuentas por Pagar Comerciales</span>
              <span class="partida-monto">{{ (balanceGeneral.cuentasPagarComerciales || 0) | currency:'PEN':'symbol':'1.0-0' }}</span>
            </div>
            <div class="partida-row">
              <span class="partida-nombre">Obligaciones Financieras (Corto Plazo)</span>
              <span class="partida-monto">{{ (balanceGeneral.obligacionesFinancierasCorto || 0) | currency:'PEN':'symbol':'1.0-0' }}</span>
            </div>
            <div class="partida-row">
              <span class="partida-nombre">Otras Cuentas por Pagar</span>
              <span class="partida-monto">{{ (balanceGeneral.otrasCuentasPorPagar || 0) | currency:'PEN':'symbol':'1.0-0' }}</span>
            </div>
            <div class="partida-row total-row">
              <span class="partida-nombre"><strong>TOTAL PASIVO CORRIENTE</strong></span>
              <span class="partida-monto"><strong>{{ (balanceGeneral.totalPasivoCorriente || 0) | currency:'PEN':'symbol':'1.0-0' }}</strong></span>
            </div>
          </div>
        </mat-expansion-panel>

        <!-- Pasivo No Corriente -->
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>schedule</mat-icon>
              Pasivo No Corriente
            </mat-panel-title>
            <mat-panel-description>
              {{ (balanceGeneral.totalPasivoNoCorriente || 0) | currency:'PEN':'symbol':'1.0-0' }}
            </mat-panel-description>
          </mat-expansion-panel-header>
          <div class="partidas-table">
            <div class="partida-row">
              <span class="partida-nombre">Obligaciones Financieras (Largo Plazo)</span>
              <span class="partida-monto">{{ (balanceGeneral.obligacionesFinancierasLargo || 0) | currency:'PEN':'symbol':'1.0-0' }}</span>
            </div>
            <div class="partida-row">
              <span class="partida-nombre">Provisiones</span>
              <span class="partida-monto">{{ (balanceGeneral.provisiones || 0) | currency:'PEN':'symbol':'1.0-0' }}</span>
            </div>
            <div class="partida-row total-row">
              <span class="partida-nombre"><strong>TOTAL PASIVO NO CORRIENTE</strong></span>
              <span class="partida-monto"><strong>{{ (balanceGeneral.totalPasivoNoCorriente || 0) | currency:'PEN':'symbol':'1.0-0' }}</strong></span>
            </div>
          </div>
        </mat-expansion-panel>

        <!-- Patrimonio -->
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>account_balance</mat-icon>
              Patrimonio
            </mat-panel-title>
            <mat-panel-description>
              {{ (balanceGeneral.totalPatrimonio || 0) | currency:'PEN':'symbol':'1.0-0' }}
            </mat-panel-description>
          </mat-expansion-panel-header>
          <div class="partidas-table">
            <div class="partida-row">
              <span class="partida-nombre">Capital Social</span>
              <span class="partida-monto">{{ (balanceGeneral.capitalSocial || 0) | currency:'PEN':'symbol':'1.0-0' }}</span>
            </div>
            <div class="partida-row">
              <span class="partida-nombre">Reserva Legal</span>
              <span class="partida-monto">{{ (balanceGeneral.reservaLegal || 0) | currency:'PEN':'symbol':'1.0-0' }}</span>
            </div>
            <div class="partida-row">
              <span class="partida-nombre">Resultados Acumulados</span>
              <span class="partida-monto">{{ (balanceGeneral.resultadosAcumulados || 0) | currency:'PEN':'symbol':'1.0-0' }}</span>
            </div>
            <div class="partida-row">
              <span class="partida-nombre">Resultado del Ejercicio</span>
              <span class="partida-monto">{{ (balanceGeneral.resultadoEjercicio || 0) | currency:'PEN':'symbol':'1.0-0' }}</span>
            </div>
            <div class="partida-row total-row">
              <span class="partida-nombre"><strong>TOTAL PATRIMONIO</strong></span>
              <span class="partida-monto"><strong>{{ (balanceGeneral.totalPatrimonio || 0) | currency:'PEN':'symbol':'1.0-0' }}</strong></span>
            </div>
          </div>
        </mat-expansion-panel>

        <!-- Firmantes -->
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>edit</mat-icon>
              Firmantes ({{ balanceGeneral.firmantes.length }})
            </mat-panel-title>
            <mat-panel-description>
              Validados con RENIEC
            </mat-panel-description>
          </mat-expansion-panel-header>
          <div class="firmantes-table">
            @for (firmante of balanceGeneral.firmantes; track firmante.dni) {
              <div class="firmante-row">
                <div class="firmante-info">
                  <div class="firmante-nombre">{{ firmante.nombre || 'Sin nombre' }}</div>
                  <div class="firmante-detalles">
                    <span>DNI: {{ firmante.dni || 'No disponible' }}</span>
                    @if (firmante.cargo) {
                      <span> • Cargo: {{ firmante.cargo }}</span>
                    }
                    @if (firmante.matricula) {
                      <span> • Matrícula: {{ firmante.matricula }}</span>
                    }
                  </div>
                </div>
                <div class="firmante-validacion">
                  @if (firmante.dniValidado === true) {
                    <mat-icon class="validacion-ok">verified</mat-icon>
                    <span class="validacion-texto ok">Validado</span>
                  } @else if (firmante.dniValidado === false) {
                    <mat-icon class="validacion-error">error</mat-icon>
                    <span class="validacion-texto error">No válido</span>
                  } @else {
                    <mat-icon class="validacion-pendiente">help</mat-icon>
                    <span class="validacion-texto pendiente">Sin validar</span>
                  }
                  @if (firmante.mensajeValidacion) {
                    <span class="validacion-mensaje">{{ firmante.mensajeValidacion }}</span>
                  }
                </div>
              </div>
            }
          </div>
        </mat-expansion-panel>

        <!-- Confianza -->
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>Confianza por campo</mat-panel-title>
          </mat-expansion-panel-header>
          <div class="confianza-grid">
            @for (item of balanceGeneral.confianza | keyvalue; track item.key) {
              <div class="confianza-item">
                <div class="confianza-item-header">
                  <span>{{ item.key }}</span>
                  <span class="confianza-pct" [class]="getConfianzaColor(item.value)">
                    {{ item.value | percent:'1.0-0' }}
                  </span>
                </div>
                <mat-progress-bar mode="determinate"
                                  [value]="item.value * 100"
                                  [class]="'bar-' + getConfianzaColor(item.value)">
                </mat-progress-bar>
              </div>
            }
          </div>
        </mat-expansion-panel>
      </mat-accordion>
    </div>
  }

  <!-- Formulario de evaluacion -->
  <mat-card class="form-card">
    <mat-card-header>
      <mat-card-title>2. Datos de Consulta</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="form" (ngSubmit)="evaluar()" class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>DNI Solicitante</mat-label>
          <input matInput formControlName="dniSolicitante" maxlength="8" placeholder="Ingrese el DNI (8 digitos)">
          @if (form.get('dniSolicitante')?.hasError('pattern')) {
            <mat-error>El DNI debe tener 8 digitos</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>RUC Empresa</mat-label>
          <input matInput formControlName="rucEmpresa" maxlength="11" placeholder="Ingrese el RUC (11 digitos)">
          @if (form.get('rucEmpresa')?.hasError('pattern')) {
            <mat-error>El RUC debe tener 11 digitos</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Profundidad de Analisis</mat-label>
          <mat-select formControlName="profundidadMaxima">
            @for (p of profundidades; track p.value) {
              <mat-option [value]="p.value">{{ p.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <div class="checkbox-row">
          <mat-checkbox formControlName="incluirDetalleGrafo">
            Incluir detalle del grafo de relaciones
          </mat-checkbox>
        </div>

        <div class="submit-row">
          <button mat-flat-button color="primary" type="submit"
                  [disabled]="form.invalid || loading">
            @if (loading) {
              <mat-spinner diameter="20"></mat-spinner>
              <span>Evaluando...</span>
            } @else {
              <ng-container>
                <mat-icon>search</mat-icon>
                <span>Evaluar</span>
              </ng-container>
            }
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Error -->
  @if (error) {
    <mat-card class="error-card">
      <mat-card-content>
        <mat-icon>error</mat-icon>
        {{ error }}
      </mat-card-content>
    </mat-card>
  }

  <!-- Resultados -->
  @if (resultado) {
    <div class="resultado-section">
      <!-- Header con score -->
      <div class="resultado-header" [class]="getHeaderClass()">
        <div class="header-left">
          <h2>Resultado de la Evaluacion</h2>
          <span class="recomendacion-label">{{ getRecomendacionText() }}</span>
        </div>
        <div class="header-score">
          <span class="score-big">{{ resultado.scoreFinal | number:'1.1-1' }}</span>
          <span class="score-label">/ 100</span>
        </div>
      </div>

      <!-- Desglose -->
      <mat-accordion multi>
        <!-- Solicitante -->
        <mat-expansion-panel expanded>
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon class="panel-icon info">person</mat-icon>
              Solicitante - {{ resultado.nombreSolicitante }}
            </mat-panel-title>
            <mat-panel-description>
              <span class="status-chip" [class]="getScoreColor(desglose!.scoreSolicitante)">
                {{ getStatusLabel(desglose!.scoreSolicitante) }}
              </span>
            </mat-panel-description>
          </mat-expansion-panel-header>
          <div class="panel-body">
            <div class="score-bar-row">
              <span>Score: {{ desglose!.scoreSolicitante | number:'1.1-1' }}</span>
              <mat-progress-bar mode="determinate" [value]="desglose!.scoreSolicitante"
                               [class]="'bar-' + getScoreColor(desglose!.scoreSolicitante)">
              </mat-progress-bar>
            </div>
            <p class="detail-label">DNI: {{ resultado.dniSolicitante }}</p>
            @if (motivosSolicitanteLimit.length > 0) {
              <ul class="motivos-list">
                @for (motivo of motivosSolicitanteLimit; track motivo) {
                  <li>{{ motivo }}</li>
                }
              </ul>
            } @else {
              <div class="no-issues">
                <mat-icon>check_circle</mat-icon>
                Sin problemas detectados
              </div>
            }
          </div>
        </mat-expansion-panel>

        <!-- Empresa -->
        <mat-expansion-panel expanded>
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon class="panel-icon secondary">business</mat-icon>
              Empresa - {{ resultado.razonSocialEmpresa }}
            </mat-panel-title>
            <mat-panel-description>
              <span class="status-chip" [class]="getScoreColor(desglose!.scoreEmpresa)">
                {{ getStatusLabel(desglose!.scoreEmpresa) }}
              </span>
            </mat-panel-description>
          </mat-expansion-panel-header>
          <div class="panel-body">
            <div class="score-bar-row">
              <span>Score: {{ desglose!.scoreEmpresa | number:'1.1-1' }}</span>
              <mat-progress-bar mode="determinate" [value]="desglose!.scoreEmpresa"
                               [class]="'bar-' + getScoreColor(desglose!.scoreEmpresa)">
              </mat-progress-bar>
            </div>
            <p class="detail-label">RUC: {{ resultado.rucEmpresa }}</p>
            @if (motivosEmpresaLimit.length > 0) {
              <ul class="motivos-list">
                @for (motivo of motivosEmpresaLimit; track motivo) {
                  <li>{{ motivo }}</li>
                }
              </ul>
            } @else {
              <div class="no-issues">
                <mat-icon>check_circle</mat-icon>
                Sin problemas detectados
              </div>
            }
          </div>
        </mat-expansion-panel>

        <!-- Red de Relaciones -->
        <mat-expansion-panel expanded>
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon class="panel-icon primary">hub</mat-icon>
              Red de Relaciones
            </mat-panel-title>
            <mat-panel-description>
              {{ desglose!.totalRelacionesAnalizadas }} vinculos analizados
              <span class="status-chip" [class]="getScoreColor(desglose!.scoreRelaciones)">
                {{ getStatusLabel(desglose!.scoreRelaciones) }}
              </span>
            </mat-panel-description>
          </mat-expansion-panel-header>
          <div class="panel-body">
            <div class="score-bar-row">
              <span>Score: {{ desglose!.scoreRelaciones | number:'1.1-1' }}</span>
              <mat-progress-bar mode="determinate" [value]="desglose!.scoreRelaciones"
                               [class]="'bar-' + getScoreColor(desglose!.scoreRelaciones)">
              </mat-progress-bar>
            </div>
            @if (desglose!.relacionesConProblemas > 0) {
              <p class="detail-label warning-text">
                {{ desglose!.relacionesConProblemas }} de {{ desglose!.totalRelacionesAnalizadas }} con alertas
              </p>
            }
            @if (motivosRelacionesLimit.length > 0) {
              <ul class="motivos-list">
                @for (motivo of motivosRelacionesLimit; track motivo) {
                  <li>{{ motivo }}</li>
                }
              </ul>
              @if (motivosRelacionesExtra > 0) {
                <p class="extra-motivos">+ {{ motivosRelacionesExtra }} problemas adicionales</p>
              }
            } @else {
              <div class="no-issues">
                <mat-icon>check_circle</mat-icon>
                Red sin problemas
              </div>
            }
          </div>
        </mat-expansion-panel>
      </mat-accordion>

      <!-- Info cards -->
      <div class="info-grid">
        <mat-card>
          <mat-card-header><mat-card-title>Informacion del Solicitante</mat-card-title></mat-card-header>
          <mat-card-content>
            <p><strong>DNI:</strong> {{ resultado.dniSolicitante }}</p>
            <p><strong>Nombre:</strong> {{ resultado.nombreSolicitante }}</p>
          </mat-card-content>
        </mat-card>
        <mat-card>
          <mat-card-header><mat-card-title>Informacion de la Empresa</mat-card-title></mat-card-header>
          <mat-card-content>
            <p><strong>RUC:</strong> {{ resultado.rucEmpresa }}</p>
            <p><strong>Razon Social:</strong> {{ resultado.razonSocialEmpresa }}</p>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Resumen de Red -->
      @if (resumen) {
        <h3>Resumen de la Red</h3>
        <div class="summary-grid">
          <mat-card class="summary-card normal">
            <mat-card-content>
              <div class="summary-value primary-text">{{ resumen.totalPersonasAnalizadas }}</div>
              <div class="summary-label">Personas</div>
            </mat-card-content>
          </mat-card>
          <mat-card class="summary-card normal">
            <mat-card-content>
              <div class="summary-value primary-text">{{ resumen.totalEmpresasAnalizadas }}</div>
              <div class="summary-label">Empresas</div>
            </mat-card-content>
          </mat-card>
          <mat-card class="summary-card warn">
            <mat-card-content>
              <div class="summary-value warning-text">{{ resumen.personasConProblemas }}</div>
              <div class="summary-label">Personas con Problemas</div>
            </mat-card-content>
          </mat-card>
          <mat-card class="summary-card warn">
            <mat-card-content>
              <div class="summary-value warning-text">{{ resumen.empresasConProblemas }}</div>
              <div class="summary-label">Empresas con Problemas</div>
            </mat-card-content>
          </mat-card>
        </div>

        @if (resumen.montoTotalDeudasVencidas > 0) {
          <div class="debt-alert">
            <mat-icon>warning</mat-icon>
            Deuda vencida total en la red: S/ {{ resumen.montoTotalDeudasVencidas | number:'1.2-2' }}
          </div>
        }
      }

      <!-- Alertas -->
      @if (resultado.alertas && resultado.alertas.length > 0) {
        <h3>Alertas Detectadas</h3>
        <div class="alertas-list">
          @for (alerta of resultado.alertas; track $index) {
            <div class="alerta-item">
              <span class="severity-chip" [class]="getSeveridadColor(alerta.severidad)">
                {{ alerta.severidad }}
              </span>
              <span class="level-badge">Nivel {{ alerta.nivelProfundidad }}</span>
              <span>{{ alerta.mensaje }}</span>
            </div>
          }
        </div>
      }

      <!-- Grafo de Relaciones -->
      @if (resultado.grafo) {
        <app-grafo-red
          [grafo]="resultado.grafo"
          [dniSolicitante]="resultado.dniSolicitante"
          [rucEmpresa]="resultado.rucEmpresa">
        </app-grafo-red>
      }
    </div>
  }
</div>
