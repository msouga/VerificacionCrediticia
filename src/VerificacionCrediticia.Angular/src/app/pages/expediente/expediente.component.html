@if (loading) {
  <div class="loading-container">
    <mat-spinner diameter="48"></mat-spinner>
    <p>Cargando expediente...</p>
  </div>
}

@if (error && !expediente) {
  <mat-card class="error-card">
    <mat-card-content>
      <mat-icon>error</mat-icon>
      <span>{{ error }}</span>
    </mat-card-content>
  </mat-card>
}

<!-- Vista del expediente -->
@if (expediente) {
  <div class="expediente-container">

    <!-- Header del expediente -->
    <mat-card class="header-card">
      <mat-card-content>
        <div class="header-row">
          <div class="header-info">
            <h2>Expediente #{{ expediente.id }} - {{ expediente.descripcion }}</h2>
            <div class="header-details">
              @if (expediente.dniSolicitante) {
                <span class="detail-item">
                  <mat-icon>badge</mat-icon>
                  DNI: {{ expediente.dniSolicitante }}
                </span>
              }
              @if (nombreCompleto) {
                <span class="detail-item">
                  <mat-icon>person</mat-icon>
                  {{ nombreCompleto }}
                </span>
              }
              @if (expediente.rucEmpresa) {
                <span class="detail-item">
                  <mat-icon>business</mat-icon>
                  RUC: {{ expediente.rucEmpresa }}
                </span>
              }
              @if (expediente.razonSocialEmpresa) {
                <span class="detail-item">
                  <mat-icon>domain</mat-icon>
                  {{ expediente.razonSocialEmpresa }}
                </span>
              }
            </div>
          </div>
          <div class="header-actions">
            <span class="estado-chip" [class]="getEstadoColor(expediente.estado)">
              {{ getEstadoLabel(expediente.estado) }}
            </span>
            <button mat-stroked-button (click)="volverAListado()">
              <mat-icon>arrow_back</mat-icon>
              Volver
            </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Barra de progreso -->
    <mat-card class="progress-card">
      <mat-card-content>
        <div class="progress-header">
          <span>Documentos obligatorios</span>
          <span class="progress-count">
            {{ expediente.documentosObligatoriosCompletos }} de {{ expediente.totalDocumentosObligatorios }}
          </span>
        </div>
        <mat-progress-bar
          mode="determinate"
          [value]="progreso"
          [class.complete]="expediente.puedeEvaluar">
        </mat-progress-bar>
      </mat-card-content>
    </mat-card>

    <!-- Zona de carga masiva -->
    <mat-card class="bulk-upload-card">
      <mat-card-content>
        <div class="bulk-header">
          <mat-icon>dynamic_feed</mat-icon>
          <div>
            <h3>Carga masiva de documentos</h3>
            <p>Suba todos los documentos juntos. El sistema los clasificara automaticamente.</p>
          </div>
        </div>
        <div class="bulk-upload-zone"
             [class.drag-over]="bulkDragOver"
             [class.has-error]="bulkError"
             (dragover)="onBulkDragOver($event)"
             (dragleave)="onBulkDragLeave($event)"
             (drop)="onBulkDrop($event)">
          <input type="file"
                 class="file-input-hidden"
                 multiple
                 accept=".pdf,.jpg,.jpeg,.png,.bmp,.tiff"
                 (change)="onBulkFileSelected($event)">
          <mat-icon class="upload-icon">cloud_upload</mat-icon>
          <p>Arrastre archivos aqui o haga clic para seleccionar</p>
          <span class="upload-hint">Multiples archivos PDF, JPG, PNG, BMP o TIFF - Max 4 MB c/u</span>
        </div>
        @if (bulkLoading) {
          <div class="subiendo-info">
            <mat-spinner diameter="20"></mat-spinner>
            <span>Subiendo archivos...</span>
          </div>
        }
        @if (bulkError) {
          <div class="slot-error">
            <mat-icon>warning</mat-icon>
            <span>{{ bulkError }}</span>
          </div>
        }
      </mat-card-content>
    </mat-card>

    <!-- Documentos en clasificacion -->
    @if (documentosEnClasificacion.length > 0) {
      <mat-card class="clasificando-card">
        <mat-card-content>
          <h3>Clasificando documentos...</h3>
          @for (doc of documentosEnClasificacion; track doc.id) {
            <div class="doc-resumen doc-clasificando" [class.doc-error]="doc.estado === 3">
              <div class="doc-info">
                @if (doc.estado === 1) {
                  <mat-spinner diameter="20"></mat-spinner>
                } @else if (doc.estado === 3) {
                  <mat-icon class="estado-error">error</mat-icon>
                } @else {
                  <mat-icon class="estado-subido">cloud_done</mat-icon>
                }
                <div>
                  <strong>{{ doc.nombreArchivo }}</strong>
                  <span class="doc-fecha">
                    @if (doc.estado === 1) {
                      Clasificando con IA...
                    } @else if (doc.estado === 3) {
                      {{ doc.errorMensaje || 'Error desconocido' }}
                    } @else {
                      En cola de clasificacion...
                    }
                  </span>
                </div>
              </div>
              @if (doc.estado === 3) {
                <div class="doc-actions-clasificacion">
                  <button mat-icon-button
                          color="warn"
                          matTooltip="Descartar documento"
                          (click)="descartarDocumento(doc)">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              }
            </div>
          }
        </mat-card-content>
      </mat-card>
    }

    <!-- Lista de documentos -->
    <mat-accordion multi>
      @for (slot of documentoSlots; track slot.tipo.id) {
        <mat-expansion-panel [expanded]="!slot.documento">
          <mat-expansion-panel-header>
            <mat-panel-title>
              @if (slot.documento) {
                <mat-icon [class]="getDocEstadoClass(slot.documento.estado)">
                  {{ getDocEstadoIcon(slot.documento.estado) }}
                </mat-icon>
              } @else {
                <mat-icon class="estado-pendiente">upload_file</mat-icon>
              }
              <span>{{ slot.tipo.nombre }}</span>
              @if (slot.tipo.esObligatorio) {
                <span class="obligatorio-badge">Obligatorio</span>
              }
            </mat-panel-title>
            <mat-panel-description>
              @if (slot.documento) {
                {{ slot.documento.nombreArchivo }}
                @if (slot.documento.confianzaPromedio !== null && slot.documento.estado === 2) {
                  - Confianza: {{ slot.documento.confianzaPromedio | percent:'1.0-0' }}
                }
                @if (slot.documento.estado === 1) {
                  - Procesando...
                }
                @if (slot.documento.estado === 4) {
                  - En cola
                }
              } @else {
                Sin documento
              }
            </mat-panel-description>
          </mat-expansion-panel-header>

          <div class="slot-content">
            @if (slot.tipo.descripcion) {
              <p class="tipo-descripcion">{{ slot.tipo.descripcion }}</p>
            }

            <!-- Documento en procesamiento background -->
            @if (slot.documento && slot.documento.estado === 1) {
              <div class="doc-resumen doc-procesando">
                <div class="doc-info">
                  <mat-spinner diameter="20"></mat-spinner>
                  <div>
                    <strong>{{ slot.documento.nombreArchivo }}</strong>
                    <span class="doc-fecha">Procesando con IA...</span>
                  </div>
                </div>
              </div>
            }

            <!-- Documento subido (pendiente de procesamiento) -->
            @if (slot.documento && slot.documento.estado === 4) {
              <div class="doc-resumen doc-subido">
                <div class="doc-info">
                  <mat-icon class="estado-subido">cloud_done</mat-icon>
                  <div>
                    <strong>{{ slot.documento.nombreArchivo }}</strong>
                    <span class="doc-fecha">En cola de procesamiento...</span>
                  </div>
                </div>
                <div class="doc-actions">
                  <div class="upload-zone compact"
                       [class.drag-over]="slot.dragOver"
                       (dragover)="onDragOver($event, slot)"
                       (dragleave)="onDragLeave($event, slot)"
                       (drop)="onDrop($event, slot)">
                    <input type="file"
                           class="file-input-hidden"
                           accept=".pdf,.jpg,.jpeg,.png,.bmp,.tiff"
                           (change)="onFileSelected($event, slot)">
                    <mat-icon>swap_horiz</mat-icon>
                    <span>Reemplazar</span>
                  </div>
                </div>
              </div>
            }

            <!-- Documento ya procesado -->
            @if (slot.documento && slot.documento.estado === 2) {
              <div class="doc-resumen">
                <div class="doc-info">
                  <mat-icon>description</mat-icon>
                  <div>
                    <strong>{{ slot.documento.nombreArchivo }}</strong>
                    <span class="doc-fecha">Procesado: {{ slot.documento.fechaProcesado | date:'dd/MM/yyyy HH:mm' }}</span>
                  </div>
                </div>
                <div class="doc-actions">
                  <div class="upload-zone compact"
                       [class.drag-over]="slot.dragOver"
                       (dragover)="onDragOver($event, slot)"
                       (dragleave)="onDragLeave($event, slot)"
                       (drop)="onDrop($event, slot)">
                    <input type="file"
                           class="file-input-hidden"
                           accept=".pdf,.jpg,.jpeg,.png,.bmp,.tiff"
                           (change)="onFileSelected($event, slot)">
                    <mat-icon>swap_horiz</mat-icon>
                    <span>Reemplazar</span>
                  </div>
                </div>
              </div>
            }

            <!-- Documento con error -->
            @if (slot.documento && slot.documento.estado === 3) {
              <div class="doc-error-info">
                <mat-icon>error</mat-icon>
                <span>Error: {{ slot.documento.errorMensaje || 'Error desconocido' }}</span>
              </div>
            }

            <!-- Zona de upload (si no hay documento o hay error) -->
            @if (!slot.documento || slot.documento.estado === 3) {
              <div class="upload-zone"
                   [class.drag-over]="slot.dragOver"
                   [class.has-error]="slot.error"
                   (dragover)="onDragOver($event, slot)"
                   (dragleave)="onDragLeave($event, slot)"
                   (drop)="onDrop($event, slot)">
                <input type="file"
                       class="file-input-hidden"
                       accept=".pdf,.jpg,.jpeg,.png,.bmp,.tiff"
                       (change)="onFileSelected($event, slot)">
                <mat-icon class="upload-icon">cloud_upload</mat-icon>
                <p>Arrastre un archivo aqui o haga clic para seleccionar</p>
                <span class="upload-hint">PDF, JPG, PNG, BMP o TIFF - Max 4 MB</span>
              </div>
            }

            <!-- Subiendo archivo -->
            @if (slot.loading) {
              <div class="subiendo-info">
                <mat-spinner diameter="20"></mat-spinner>
                <span>Subiendo archivo...</span>
              </div>
            }

            <!-- Error de validacion -->
            @if (slot.error) {
              <div class="slot-error">
                <mat-icon>warning</mat-icon>
                <span>{{ slot.error }}</span>
              </div>
            }
          </div>
        </mat-expansion-panel>
      }
    </mat-accordion>

    <!-- Boton Evaluar / Reprocesar -->
    <div class="evaluar-section">
      @if (error) {
        <div class="evaluar-error">
          <mat-icon>error</mat-icon>
          <span>{{ error }}</span>
        </div>
      }
      <button mat-raised-button color="primary"
              class="evaluar-btn"
              [disabled]="!puedeEvaluar"
              (click)="evaluar()"
              [matTooltip]="!puedeEvaluar ? (hayDocumentosProcesandose() ? 'Espere a que terminen de procesarse los documentos' : 'Complete todos los documentos obligatorios para evaluar') : ''">
        <mat-icon>{{ expediente.estado === 3 ? 'refresh' : 'gavel' }}</mat-icon>
        {{ expediente.estado === 3 ? 'Reprocesar Expediente' : 'Evaluar Expediente' }}
      </button>
      @if (hayDocumentosProcesandose()) {
        <p class="evaluar-hint">
          Procesando documentos con IA, espere un momento...
        </p>
      } @else if (!expediente.puedeEvaluar) {
        <p class="evaluar-hint">
          Faltan {{ expediente.totalDocumentosObligatorios - expediente.documentosObligatoriosCompletos }}
          documento(s) obligatorio(s) por subir
        </p>
      }
    </div>

    <!-- Resultado de Evaluacion -->
    @if (expediente.resultadoEvaluacion) {
      <mat-card class="resultado-card" [class]="getRecomendacionClass(expediente.resultadoEvaluacion.recomendacion)">
        <mat-card-header>
          <mat-icon mat-card-avatar>assessment</mat-icon>
          <mat-card-title>Resultado de Evaluacion</mat-card-title>
          <mat-card-subtitle>
            Evaluado: {{ expediente.resultadoEvaluacion.fechaEvaluacion | date:'dd/MM/yyyy HH:mm' }}
          </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="resultado-header">
            <div class="resultado-score">
              <span class="score-valor">{{ expediente.resultadoEvaluacion.scoreFinal | number:'1.1-1' }}</span>
              <span class="score-label">Score Final</span>
              @if (expediente.resultadoEvaluacion.penalidadRed > 0) {
                <span class="penalidad-red">
                  -{{ expediente.resultadoEvaluacion.penalidadRed | number:'1.1-1' }} por red de relaciones
                </span>
              }
            </div>
            <div class="resultado-recomendacion" [class]="getRecomendacionClass(expediente.resultadoEvaluacion.recomendacion)">
              <span class="rec-text">{{ getRecomendacionLabel(expediente.resultadoEvaluacion.recomendacion) }}</span>
              <span class="rec-riesgo">Riesgo: {{ getNivelRiesgoLabel(expediente.resultadoEvaluacion.nivelRiesgo) }}</span>
            </div>
          </div>

          @if (expediente.resultadoEvaluacion.resumen) {
            <div class="narrativa-section">
              <div class="narrativa-header">
                <mat-icon>auto_stories</mat-icon>
                <h3>Informe Narrativo</h3>
              </div>
              <div class="narrativa-contenido">
                @for (parrafo of expediente.resultadoEvaluacion.resumen.split('\n'); track $index) {
                  @if (parrafo.trim()) {
                    <p>{{ parrafo }}</p>
                  }
                }
              </div>
            </div>
          }

          <!-- Linea de credito recomendada -->
          @if (expediente.resultadoEvaluacion.lineaCredito) {
            <div class="linea-credito-card">
              <div class="linea-credito-header">
                <mat-icon>account_balance</mat-icon>
                <h3>Linea de Credito Recomendada</h3>
              </div>
              <div class="linea-credito-monto">
                <span class="monto-moneda">{{ expediente.resultadoEvaluacion.lineaCredito.moneda }}</span>
                <span class="monto-valor">{{ expediente.resultadoEvaluacion.lineaCredito.montoMaximoSugerido | number:'1.2-2' }}</span>
              </div>
              <p class="linea-credito-justificacion">{{ expediente.resultadoEvaluacion.lineaCredito.justificacion }}</p>
              <div class="linea-credito-detalles">
                @for (detalle of expediente.resultadoEvaluacion.lineaCredito.detalles; track $index) {
                  <div class="detalle-linea">
                    <span class="detalle-concepto">{{ detalle.concepto }}</span>
                    <span class="detalle-calculo">
                      {{ detalle.porcentaje }}% de {{ detalle.valorBase | number:'1.2-2' }}
                      = <strong>{{ detalle.montoCalculado | number:'1.2-2' }}</strong>
                    </span>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Red de relaciones -->
          @if (expediente.resultadoEvaluacion.exploracionRed) {
            <div class="red-relaciones-section">
              <div class="red-header">
                <mat-icon>hub</mat-icon>
                <h3>Red de Relaciones Crediticias</h3>
                <span class="red-stats">
                  {{ expediente.resultadoEvaluacion.exploracionRed.totalNodos }} nodos
                  ({{ expediente.resultadoEvaluacion.exploracionRed.totalPersonas }} personas,
                  {{ expediente.resultadoEvaluacion.exploracionRed.totalEmpresas }} empresas)
                </span>
              </div>
              <div class="red-nodos-grid">
                @for (nodoEntry of getNodosOrdenados(expediente.resultadoEvaluacion.exploracionRed); track nodoEntry.id) {
                  <div class="nodo-item" [class]="getNodoRiesgoClass(nodoEntry.nodo)">
                    <div class="nodo-header">
                      <mat-icon>{{ nodoEntry.nodo.tipo === 0 ? 'person' : 'business' }}</mat-icon>
                      <div class="nodo-info">
                        <span class="nodo-nombre">{{ nodoEntry.nodo.nombre }}</span>
                        <span class="nodo-id">{{ nodoEntry.nodo.tipo === 0 ? 'DNI' : 'RUC' }}: {{ nodoEntry.id }}</span>
                      </div>
                      <div class="nodo-badges">
                        <span class="nodo-nivel">Nivel {{ nodoEntry.nodo.nivelProfundidad }}</span>
                        @if (nodoEntry.nodo.nivelRiesgoTexto) {
                          <span class="nodo-riesgo" [class]="getNodoRiesgoChipClass(nodoEntry.nodo)">
                            {{ nodoEntry.nodo.nivelRiesgoTexto }}
                          </span>
                        }
                      </div>
                    </div>
                    @if (nodoEntry.nodo.alertas.length > 0) {
                      <div class="nodo-alertas">
                        @for (alerta of nodoEntry.nodo.alertas; track $index) {
                          <span class="alerta-chip">{{ alerta }}</span>
                        }
                      </div>
                    }
                    @if (nodoEntry.nodo.conexiones.length > 0) {
                      <div class="nodo-conexiones">
                        @for (con of nodoEntry.nodo.conexiones; track $index) {
                          <span class="conexion-chip">
                            {{ con.tipoRelacion }}: {{ con.nombre }}
                          </span>
                        }
                      </div>
                    }
                  </div>
                }
              </div>
            </div>
          }

          <!-- Validaciones cruzadas -->
          @if (expediente.resultadoEvaluacion.validacionesCruzadas.length) {
            <h3>Validaciones de Documentos</h3>
            <div class="validaciones-grid">
              @for (validacion of expediente.resultadoEvaluacion.validacionesCruzadas; track $index) {
                <div class="validacion-item" [class]="getValidacionClass(validacion)">
                  <div class="validacion-header">
                    <mat-icon>{{ validacion.aprobada ? 'check_circle' : (validacion.severidad === 1 ? 'cancel' : 'warning') }}</mat-icon>
                    <span class="validacion-nombre">{{ validacion.nombre }}</span>
                  </div>
                  <p class="validacion-mensaje">{{ validacion.mensaje }}</p>
                  <div class="validacion-docs">
                    @for (doc of validacion.documentosInvolucrados; track $index) {
                      <span class="validacion-doc-chip">{{ doc }}</span>
                    }
                  </div>
                </div>
              }
            </div>
          }

          <!-- Reglas aplicadas -->
          @if (expediente.resultadoEvaluacion.reglasAplicadas.length > 0) {
            <h3>Reglas Aplicadas</h3>
            <div class="reglas-grid">
              @for (regla of expediente.resultadoEvaluacion.reglasAplicadas; track $index) {
                <div class="regla-item" [class]="getReglaResultadoClass(regla)">
                  <div class="regla-header">
                    <mat-icon>{{ regla.cumplida ? 'check_circle' : 'cancel' }}</mat-icon>
                    <span class="regla-nombre">{{ regla.nombreRegla }}</span>
                  </div>
                  <div class="regla-detalle">
                    <span>{{ regla.campoEvaluado }} {{ regla.operador }} {{ regla.valorEsperado | number:'1.2-2' }}</span>
                    @if (regla.valorReal !== null) {
                      <span class="regla-real">Valor real: {{ regla.valorReal | number:'1.2-2' }}</span>
                    }
                  </div>
                  @if (regla.mensaje) {
                    <p class="regla-mensaje">{{ regla.mensaje }}</p>
                  }
                </div>
              }
            </div>
          }
        </mat-card-content>
      </mat-card>
    }
  </div>
}
